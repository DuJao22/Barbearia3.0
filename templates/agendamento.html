{% extends "base.html" %}

{% block title %}Novo Agendamento - {{ configuracoes_barbearia.nome_barbearia if configuracoes_barbearia else 'Barbearia Premium' }}{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-calendar-plus"></i> Novo Agendamento</h1>
    <p>Escolha o funcionário, serviço e horário desejado</p>
</div>

{% if fidelidade and fidelidade[3] > 0 %}
<div style="background: #1b5e20; color: #c8e6c9; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center; border: 1px solid #2e7d32;">
    <i class="fas fa-gift"></i> <strong>Você tem {{ fidelidade[3] }} corte(s) gratuito(s) disponível(is)!</strong>
    <br>Marque a opção abaixo para usar um corte gratuito.
</div>
{% endif %}

<div class="card">
    <form method="POST">
        <div class="grid-2">
            <div class="form-group">
                <label for="funcionario_id">Funcionário:</label>
                <select id="funcionario_id" name="funcionario_id" class="form-control" required>
                    <option value="">Selecione um funcionário</option>
                    {% for funcionario in funcionarios %}
                        <option value="{{ funcionario[0] }}">{{ funcionario[1] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="servico_id">Serviço:</label>
                <select id="servico_id" name="servico_id" class="form-control" required>
                    <option value="">Selecione um serviço</option>
                    {% for servico in servicos %}
                        <option value="{{ servico[0] }}" data-preco="{{ servico[2] }}">
                            {{ servico[1] }} - R$ {{ "%.2f"|format(servico[2]) }} ({{ servico[3] }}min)
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label for="data">Data:</label>
                <input type="date" id="data" name="data" class="form-control" 
                       min="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
            </div>

            <div class="form-group">
                <label for="horario">Horário:</label>
                <select id="horario" name="horario" class="form-control" required disabled>
                    <option value="">Selecione primeiro o funcionário e a data</option>
                </select>
            </div>
        </div>

        {% if fidelidade and fidelidade[3] > 0 %}
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="usar_corte_gratuito" name="usar_corte_gratuito" style="transform: scale(1.2);">
                <span style="color: #28a745; font-weight: bold;">
                    <i class="fas fa-gift"></i> Usar um corte gratuito ({{ fidelidade[3] }} disponível(is))
                </span>
            </label>
        </div>
        {% endif %}

        <div id="resumo_agendamento" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; display: none;">
        <div id="resumo_agendamento" style="background: #404040; padding: 1rem; border-radius: 8px; margin: 1rem 0; display: none; border: 1px solid #555;">
            <h4>Resumo do Agendamento:</h4>
            <p><strong>Funcionário:</strong> <span id="resumo_funcionario">-</span></p>
            <p><strong>Serviço:</strong> <span id="resumo_servico">-</span></p>
            <p><strong>Data/Hora:</strong> <span id="resumo_data_hora">-</span></p>
            <p><strong>Valor:</strong> <span id="resumo_valor" class="money">-</span></p>
        </div>

        <button type="submit" class="btn" style="width: 100%;">
            <i class="fas fa-check"></i> Confirmar Agendamento
        </button>
    </form>
</div>

<div style="text-align: center; margin-top: 2rem;">
    <a href="{{ url_for('dashboard_cliente') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
    </a>
</div>

<script>
    const funcionarioSelect = document.getElementById('funcionario_id');
    const dataInput = document.getElementById('data');
    const horarioSelect = document.getElementById('horario');
    const servicoSelect = document.getElementById('servico_id');
    const usarCorteGratuito = document.getElementById('usar_corte_gratuito');
    const resumoDiv = document.getElementById('resumo_agendamento');

    function atualizarHorarios() {
        const funcionarioId = funcionarioSelect.value;
        const data = dataInput.value;

        if (funcionarioId && data) {
            fetch(`/api/horarios_disponiveis?funcionario_id=${funcionarioId}&data=${data}`)
                .then(response => response.json())
                .then(data => {
                    horarioSelect.innerHTML = '';
                    horarioSelect.disabled = false;

                    if (data.horarios_disponiveis.length > 0) {
                        horarioSelect.innerHTML = '<option value="">Selecione um horário</option>';
                        data.horarios_disponiveis.forEach(horario => {
                            const option = document.createElement('option');
                            option.value = horario;
                            option.textContent = horario;
                            horarioSelect.appendChild(option);
                        });
                    } else {
                        horarioSelect.innerHTML = '<option value="">Nenhum horário disponível</option>';
                        horarioSelect.disabled = true;
                    }
                    atualizarResumo();
                });
        } else {
            horarioSelect.innerHTML = '<option value="">Selecione primeiro o funcionário e a data</option>';
            horarioSelect.disabled = true;
            atualizarResumo();
        }
    }

    function atualizarResumo() {
        const funcionario = funcionarioSelect.options[funcionarioSelect.selectedIndex]?.text || '-';
        const servico = servicoSelect.options[servicoSelect.selectedIndex]?.text || '-';
        const data = dataInput.value;
        const horario = horarioSelect.value;
        const servicoSelecionado = servicoSelect.options[servicoSelect.selectedIndex];
        const preco = servicoSelecionado ? parseFloat(servicoSelecionado.dataset.preco) : 0;
        const gratuito = usarCorteGratuito && usarCorteGratuito.checked;

        document.getElementById('resumo_funcionario').textContent = funcionario;
        document.getElementById('resumo_servico').textContent = servico;
        
        if (data && horario) {
            const dataFormatada = new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
            document.getElementById('resumo_data_hora').textContent = `${dataFormatada} às ${horario}`;
        } else {
            document.getElementById('resumo_data_hora').textContent = '-';
        }

        if (gratuito) {
            document.getElementById('resumo_valor').innerHTML = '<span style="color: #28a745; font-weight: bold;">GRATUITO</span>';
        } else if (preco > 0) {
            document.getElementById('resumo_valor').textContent = `R$ ${preco.toFixed(2)}`;
        } else {
            document.getElementById('resumo_valor').textContent = '-';
        }

        // Mostrar resumo se todos os campos estão preenchidos
        if (funcionario !== '-' && servico !== '-' && data && horario) {
            resumoDiv.style.display = 'block';
        } else {
            resumoDiv.style.display = 'none';
        }
    }

    // Combinar data e horário no campo data_hora antes do envio
    document.querySelector('form').addEventListener('submit', function(e) {
        const data = dataInput.value;
        const horario = horarioSelect.value;
        
        if (data && horario) {
            const dataHora = `${data} ${horario}:00`;
            
            // Criar campo hidden com data_hora combinada
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'data_hora';
            hiddenInput.value = dataHora;
            this.appendChild(hiddenInput);
        }
    });

    funcionarioSelect.addEventListener('change', atualizarHorarios);
    dataInput.addEventListener('change', atualizarHorarios);
    horarioSelect.addEventListener('change', atualizarResumo);
    servicoSelect.addEventListener('change', atualizarResumo);
    if (usarCorteGratuito) {
        usarCorteGratuito.addEventListener('change', atualizarResumo);
    }
</script>
{% endblock %}